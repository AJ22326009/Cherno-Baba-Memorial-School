<div class="container mt-4">
    <div class="small-box">
        <div class="card-body">
            <form [formGroup]="positionGenerationForm" (ngSubmit)="generatePositions()">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <select class="form-control" formControlName="term" required>
                                <option value="">Select Term</option>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <button type="submit" class="btn btn-primary" [disabled]="positionGenerationForm.invalid">
                            @if(loadingPositions){
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            } @else {
                            <i class="fas fa-trophy"></i> Generate Positions
                            }
                        </button>
                        @if(shouldGeneratePosition){
                            <i class="fas fa-warning text-danger"></i>
                            <small class="text-danger">Please generate positions</small>}
                    </div>

                </div>
            </form>
        </div>
    </div>

    <div class="bg d-flex justify-content-around align-items-center">
        <a class="btn btn-primary m-2" (click)="toEnterMode()"><i class="fas fa-edit"></i> Enter Student Results</a>
    </div>

    @if(resultEnterMode || resultUpdateMode){
    <div class="card card-primary" id="enterUpdate">
        <div class="card-header">
            <h3 class="card-title">{{ resultEnterMode ? 'Enter Student Results' : 'Update Student Results' }}</h3>
        </div>

        <form (ngSubmit)="resultEnterMode ? saveResults() : updateResults()" [formGroup]="resultsForm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="studentSelect">Select Student</label>
                            <select class="form-control" id="studentSelect" formControlName="studentName">
                                <option value="">-- Select Student --</option>
                                @for(student of students; track student.admissionNumber){
                                <option [value]="student.fullName">{{student.fullName}}</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="termSelect">Term</label>
                            <select class="form-control" id="termSelect" formControlName="term">
                                <option value="">-- Select Term --</option>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr>
                <h5 class="mb-3">Subject Scores (Max: 100)</h5>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group d-flex align-items-center justify-content-between border-bottom pb-2">
                            <label class="mb-0">English</label>
                            <input type="number" class="form-control w-25" placeholder="0" formControlName="English">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group d-flex align-items-center justify-content-between border-bottom pb-2">
                            <label class="mb-0">Maths</label>
                            <input type="number" class="form-control w-25" placeholder="0" formControlName="Maths">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group d-flex align-items-center justify-content-between border-bottom pb-2">
                            <label class="mb-0">Phonics</label>
                            <input type="number" class="form-control w-25" placeholder="0" formControlName="Phonics">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group d-flex align-items-center justify-content-between border-bottom pb-2">
                            <label class="mb-0">Verbal</label>
                            <input type="number" class="form-control w-25" placeholder="0" formControlName="Verbal">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer">
                <button type="button" (click)="cancel()" class="btn btn-secondary float-left">
                   <i class="fas fa-times"></i> cancel
                </button>
                <button type="submit" class="btn btn-success float-right" [disabled]="resultsForm.invalid">
                    @if(loadingEnterUpdate){
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    }@else {
                        <i class="fas fa-save"></i>{{ resultEnterMode ? ' Save' : ' Update' }}
                    }
                </button>
            </div>
        </form>
    </div>
    }
    <!-- should be in results component -->
    <div class="mb-4 mt-4" id="searchResults">
        <h3>Results Search</h3>
        <div class="card">
            <div class="card-body">
                <form [formGroup]="searchForm" (ngSubmit)="onSearch()">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="form-group">
                                <select class="form-control" formControlName="studentName">
                                    <option value="">Select student</option>
                                    <option value="all" class="text-bold">All students</option>
                                     @for(student of students; track student.admissionNumber){
                                    <option [value]="student.fullName">{{student.fullName}}</option>
                                     }
                                </select>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <div class="form-group">
                                <select class="form-control" formControlName="term">
                                    <option value="">Select Term</option>
                                    <option value="Term 1">Term 1</option>
                                    <option value="Term 2">Term 2</option>
                                    <option value="Term 3">Term 3</option>
                                    <option value="all">All Terms</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary" [disabled]="searchForm.invalid">
                                @if(loadingResults){
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                }@else {
                                <i class="fas fa-search"></i> Search
                                }
                            </button>
                        </div>
                    </div>
                </form>

                <div class="d-flex flex-column gap-2">
                    @if(noResults){
                    <p class="text-center mt-3 text-danger">No results found.</p>
                    }
                    @for(result of results; track result._id){
                    <div class="card table-responsive border border-info">
                        <div class="card-body" [id]="result._id">
                            <div class="border-0">
                                <div style="min-width: 600px;">
                                    <div class="row mb-3">
                                        <div class="col-4">
                                            <p class="mb-1"><strong>Name:</strong> {{result.student.fullName}}</p>
                                            <p class="mb-0"><strong>Class:</strong> {{class}}</p>
                                        </div>
                                        <div class="col-4 text-center">
                                            <p class="mb-1"><strong>Gender:</strong> {{result.student.gender}}</p>
                                            <p class="mb-0"><strong># in class:</strong> {{students.length}}</p>
                                        </div>
                                        <div class="col-4 text-right">
                                            <p class="mb-1"><strong>{{result.term}}</strong></p>
                                            <p class="mb-0"><strong>Teacher:</strong> {{teacher}}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr>

                            <div>
                                <table class="table table-bordered text-nowrap" style="min-width: 600px;">
                                    <thead class="bg-light">
                                        <tr>
                                            <th style="width: 70%;">Subject</th>
                                            <th style="width: 30%;">Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for(sub of result.scores; track sub.subject){
                                        <tr>
                                            <td>{{sub.subject}}</td>
                                            <td>{{sub.score}}</td>
                                        </tr>
                                        }
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-light">
                                            <th class="text-right">Total:</th>
                                            <td class="text-bold">{{result.total}}</td>
                                        </tr>
                                        <tr class="bg-light">
                                            <th class="text-right">Position:</th>
                                            <td class="text-bold text-primary">{{result.position}}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="card-footer bg-white border-top-0 d-flex justify-content-between">
                            <button type="button" class="btn btn-danger" (click)="deleteResult(result._id)">
                                @if(loadingDelete && deleteResultId === result._id){
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                } @else {
                                <i class="fas fa-trash" ></i> delete
                                }
                            </button>
                            <button type="button" class="btn btn-primary"(click)="toUpdateMode(result)">
                                <i class="fas fa-edit" ></i> edit
                            </button>
                            <button type="button" class="btn btn-primary" ngxPrint [printSectionId]="result._id" [useExistingCss]="true">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div> 
                    </div>
                }
                </div>
                @if(results.length > 0){
                <button type="button" class="btn btn-secondary mt-3" (click)="clearSearch()">
                    <i class="fas fa-times"></i> clear search
                </button>
                }
            </div>
        </div>


    </div>

     @if(error){
    <div class="alert alert-danger" role="alert" style="position: fixed; bottom: 20px; right: 20px;">
        {{ error }}
    </div>
    }

    @if(success){
    <div class="alert alert-success" role="alert" style="position: fixed; bottom: 20px; right: 20px;">
        {{ success }}
    </div>
    }
</div>